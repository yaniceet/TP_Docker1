name: CI devops 2025

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  test-backend:
    runs-on: ubuntu-24.04 # Version plus récente que 'ubuntu-latest'

    steps:
    - name: Checkout your github code using actions/checkout@v4
      uses: actions/checkout@v4

   # ... (votre code existant)

    # Étape 2: Configurer l'environnement Java
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21' 
        distribution: 'temurin'
        # MODIFICATION : Utilisation du chemin simple-api

    # Étape 3: Construire le projet et exécuter les tests
    - name: Build with Maven and run tests
      # MODIFICATION : Utilisation de l'option -f avec le chemin simple-api
      run: mvn clean verify -f BackendAPI/pom.xml

  # define job to build and publish docker image
  build-and-push-docker-image:
      needs: test-backend
      # run only when code is compiling and tests are passing
      runs-on: ubuntu-24.04

      # steps to perform in job
      steps:
          - name: Login to DockerHub
            run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Build image and push backend
            uses: docker/build-push-action@v6
            with:
              # relative path to the place where source code with Dockerfile is located
              context: ./BackendAPI
              # Note: tags has to be all lower-case
              tags:  ${{secrets.DOCKERHUB_USERNAME}}/tp-devops-simple-api:latest
              # build on feature branches, push only on main branch
              push: ${{ github.ref == 'refs/heads/main' }}

          - name: Build image and push database
              # DO the same for database

          - name: Build image and push httpd
        # DO the same for httpd
